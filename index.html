<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="shortcut icon" href="assets/images/graph-up.svg" type="image/x-icon">
  <link rel="stylesheet" href="assets/css/bootstrap@5.1.3_dist_css_bootstrap.min.css">
  <link rel="stylesheet" href="assets/css/bootstrap-icons@1.11.0_font_bootstrap-icons.css">
  <script src="assets/js/bootstrap@5.3.2_dist_js_bootstrap.bundle.min.js"></script>
  <title>Workload Statistics</title>
    <style>
      #deleteOs:hover {color: red !important;
        cursor: pointer;
      }
    </style>
</head>

<body class="pt-4">
  <div  class="container border rounded col-6 my-3  p-3 " x-data="alpine()" x-init="refreshInventory()">
    <h4 class="mb-4"><i class="bi bi-graph-up text-success fw-bolder"></i><span style="color:#102820;" class="ms-3"> Workload Statistics and Out of Stock  </span></h4>
    <form class="needs-validation">

      <div class="mb-3 ">
        <label style="width: 150px;" class=" mx-2 form-label" for="source" class="d-inline-block me-1">Document type </label>
        <select x-model="OrderCartegory" class="form-select d-inline-block" style="width: 150px;" name="source" required
          id="source">
          <option selected  class="form-text" value="">Select...</option>
          <option value="Outpatient">Prescription</option>
          <option value="Inpatient">T.Sheet</option>
          <option value="S11">S11/IRQ</option>
        </select>
      </div> <!-- workload source-->

      <div class="mb-3 d-inline-flex align-items-center">
        <label class=" mx-2 form-label" for="no-of-items">Number of Documents </label>
        <input x-model="NumberOfDocuments" class="form-control" style="width: 150px;" 
          name="number-of-docs"  type="number" value="1" id="number-of-items" onclick="this.select()" required min="1"
        >
        <div ><small class="invalid-feedback">This field is required</small></div>
      </div> <!-- Number of items listed -->

      <div class="mb-3 d-inline-flex align-items-center">
        <label class="mx-2 form-label" for="no-of-items">Number of items listed</label>
        <input x-model="ItemsOrdered" class="form-control" required min="1" style="width: 150px;" 
          type="number" name="number-of-items" id="number-of-items" onclick="this.select()" 
        >
        <div class="invalid-feedback">This field is required</div>
      </div> <!-- Number of items listed -->


      <table class="table table-striped bg-light">
        <tr>
          <th>#</th>
          <th>Generic Description</th>
          <th>BrandName</th>
          <th>X</th>
        </tr>
        <template x-for="(item,index) of osList">
          <tr>
            <td x-text="index + 1"></td>
            <td class="text-wrap" style="width: 300px;" x-text="item.GenericDescription"></td>
            <td x-text="item.BrandName ==''? 'Generic' : item.BrandName"></td>
            <td><i id="deleteOs" class="bi bi-trash" @click="osList.splice(index,1)"></i></td>
          </tr>
        </template>
      </table> <!-- table of out of stock -->


 
      <div class="dropdown">        
        <input x-model="search" class="dropdown-toggle form-control" style="width: 50%;" data-bs-toggle="dropdown" autocomplete="false"
          placeholder="Add out of stock(s) ..."
        ><!-- Dropdown filter-->
        <ul class="dropdown-menu" style="width:100%;height: 300px;overflow:auto;" aria-expanded="false">
          <template x-for="item in filteredInventory">
            <li class="dropdown-item " @click="increamentOS(item);search=''" style="cursor: pointer;">
              <a>
                <span class="text-wrap" x-text="item.Code + ' ' + item.GenericDescription"></span>
                <span x-text="item.BrandName == '' ? '' : ': ' + item.BrandName"></span>
              </a>
            </li>
          </template>
          <li class="ps-2" x-show="search!='' && !filteredInventory.length">
            <span class="fw-bold" x-text="search + ' '"></span> does not exist.
            <a href="https://docs.google.com/spreadsheets/d/1RX0Zz_9LkdIv5R2VeRfg0NnELdcWWF3Nad9QtCH9gAc/edit#gid=0" target="_blank">
              Click to add
            </a>, then Refresh inventory.
          </li>
        </ul><!-- Dropdown Menu -->
      </div> <!-- Dropdown -->

      <div style="margin-right: 150px;">
        <span x-show="refreshingInventory"><span class="spinner-border spinner-border-sm" ></span></span>
        <span  x-show="!refreshingInventory"><a @click="$event.preventDefault(),refreshInventory()" href="#" >Refresh inventory</a></span>
      </div>


      <div class="text-center my-3">
        <button id="submit" @click="postData(event)" class="btn btn-success mt-3 py-1 px-3" type="submit">
          <span x-show="!formSubmitting"><i class="bi bi-send"></i> <span>Save</span></span>
          <span x-show="formSubmitting" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
          <span x-show="formSubmitting" class="sr-only"> saving ...</span>
        </button>
        <button class="btn btn-outline-secondary mt-3 ms-3 py-1 px-3" onclick="window.location.reload()">Clear</button>
      </div> <!-- Submit or Clear form -->
    </form>
  </div> <!-- Container-->


  <script src="assets/js/alpinejs@3.13.0_dist_cdn.min.js" defer></script>

  <script>
    function alpine() {
      return {
        url: "https://script.google.com/macros/s/AKfycbwxgfhE5yqLlAoEPwkjnWkm0HwQfvP25RCw-Tnad6_59M0Ns-nV1CuxPVpJxy8T66-f/exec",
        search: '',
        OrderCartegory: '',
        formSubmitting: false,
        refreshingInventory: true,
        NumberOfDocuments: 1,
        ItemsOrdered: '',
        inventory: [],
        osList: [],

        get filteredInventory() {
          return this.inventory.filter(
            item => {
              const regex = new RegExp('^' + this.search + '| ' + this.search, 'i')
              if (regex.test(item['Code']) || regex.test(item['BrandName']) || regex.test(item.GenericDescription)) {
                return true
              }
              return false
            }
          )
        },

        async refreshInventory () {
          try {
            this.refreshingInventory = true;
            this.inventory = await (await fetch(this.url + '?sheet=inventory')).json();
            this.refreshingInventory = false;
            this.filteredInventory = this.inventory;            
          } catch (error) {
            alert('Error connecting. Please check your connection then refresh page.')
          }
        },

        increamentOS(item) {
          this.osList.push(item)
        },

        postData(e) {
          e.preventDefault();
          const form = document.querySelector('form');
          // Return if form is invalid
          if (!form.checkValidity()) {
            form.classList.add('was-validated');
            return
          }
          
          // Otherwise proceed with form submit
          this.formSubmitting = true;
          const workloadData = {
            OrderCartegory: this.OrderCartegory,
            NumberOfDocuments: this.NumberOfDocuments,
            ItemsOrdered: this.ItemsOrdered,
            NumberOutOfStock: this.osList.length || 0
          }

          const data = {
            workloadData,
            osList: this.osList
          }

          fetch(this.url, {
            method: "POST",
            body: JSON.stringify(data),
          })
            .then(res => res.text())
            .then(data => location.reload())
            .catch(alert("The data cannot be saved now. Try again later"))
        },

      }

    }    
  </script>
</body>

</html>